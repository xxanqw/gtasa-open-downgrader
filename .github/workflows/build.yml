name: Build OneFile Executables

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7
          
      - name: Install dependencies and build
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install pyinstaller pyside6 requests
          
          cd downgrader
          python3 -c "import sys; sys.path.append('.'); import icloud_resolver; icloud_resolver.download_and_extract_patches('https://www.icloud.com/iclouddrive/0afGK6zDBog_0drwp6YZoDLIg#Patches', 'Patches')"
          
          pyinstaller --onefile --windowed \
            --add-data "bin/xdelta3_linux:bin" \
            --add-data "bin/LICENSE.txt:bin" \
            --add-data "assets:assets" \
            --name "gtasa-open-downgrader-linux" \
            main.py
            
          pyinstaller --onefile --windowed \
            --add-data "bin/xdelta3_linux:bin" \
            --add-data "bin/LICENSE.txt:bin" \
            --add-data "assets:assets" \
            --add-data "Patches:Patches" \
            --name "gtasa-open-downgrader-linux-offline" \
            main.py
          cd ..

      - name: Package AppImages
        run: |
          sudo apt-get update
          sudo apt-get install -y libfuse2 libegl1 libgl1
          wget https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          prepare_appdir() {
            local binary_name=$1
            local output_name=$2
            local appdir="AppDir_$binary_name"
            mkdir -p $appdir/usr/bin
            mkdir -p $appdir/usr/share/applications
            cp downgrader/dist/$binary_name $appdir/usr/bin/
            
            source .venv/bin/activate
            export QT_QPA_PLATFORM=offscreen
            python3 -c "from PySide6.QtGui import QIcon; from PySide6.QtWidgets import QApplication; import sys; app=QApplication(sys.argv); icon=QIcon('downgrader/assets/icon.ico'); pixmap=icon.pixmap(256,256); pixmap.save('$appdir/$output_name.png')"
            
            echo "[Desktop Entry]" > $appdir/$output_name.desktop
            echo "Name=GTA SA Open Downgrader" >> $appdir/$output_name.desktop
            echo "Exec=$binary_name" >> $appdir/$output_name.desktop
            echo "Icon=$output_name" >> $appdir/$output_name.desktop
            echo "Type=Application" >> $appdir/$output_name.desktop
            echo "Categories=Game;" >> $appdir/$output_name.desktop
            cp $appdir/$output_name.desktop $appdir/usr/share/applications/
            
            echo "#!/bin/bash" > $appdir/AppRun
            echo 'HERE="$(dirname "$(readlink -f "${0}")")"' >> $appdir/AppRun
            echo 'export PATH="$HERE/usr/bin:$PATH"' >> $appdir/AppRun
            echo "exec \"$binary_name\" \"\$@\"" >> $appdir/AppRun
            chmod +x $appdir/AppRun
            ln -s $output_name.png $appdir/.DirIcon
            
            ARCH=x86_64 ./appimagetool-x86_64.AppImage $appdir $output_name.AppImage
          }

          prepare_appdir "gtasa-open-downgrader-linux" "gtasa-open-downgrader-linux"
          prepare_appdir "gtasa-open-downgrader-linux-offline" "gtasa-open-downgrader-linux-offline"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gta-sa-downgrader-linux-appimages
          path: "*.AppImage"

  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Install dependencies and build
        shell: powershell
        run: |
          uv venv
          .venv\Scripts\activate.ps1
          uv pip install pyinstaller pyside6 requests
          
          cd downgrader
          python -c "import sys; sys.path.append('.'); import icloud_resolver; icloud_resolver.download_and_extract_patches('https://www.icloud.com/iclouddrive/0afGK6zDBog_0drwp6YZoDLIg#Patches', 'Patches')"
          
          pyinstaller --onefile --windowed `
            --add-data "bin/xdelta3.exe;bin" `
            --add-data "bin/LICENSE.txt;bin" `
            --add-data "assets;assets" `
            --icon "assets/icon.ico" `
            --name "gtasa-open-downgrader-windows" `
            main.py
            
          pyinstaller --onefile --windowed `
            --add-data "bin/xdelta3.exe;bin" `
            --add-data "bin/LICENSE.txt;bin" `
            --add-data "assets;assets" `
            --add-data "Patches;Patches" `
            --icon "assets/icon.ico" `
            --name "gtasa-open-downgrader-windows-offline" `
            main.py
          cd ..

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: gtasa-open-downgrader-windows-builds
          path: downgrader/dist/*.exe

  release:
    needs: [build-linux, build-windows]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Move artifacts to current directory
        run: |
          find artifacts -type f \( -name "*.AppImage" -o -name "*.exe" \) -exec mv -v -t . {} +

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.AppImage
            *.exe
          body: |
            GTA SA Open Downgrader v0.1.1
            
            - Added Linux AppImage support (Online & Offline)
            - Added Windows Offline standalone executable
            - Improved Window Icons and UI theme
            - Added Application Updater (Online & Offline modes)
            - Fixed gta_sa.exe consistency across different versions
            - Various stability and UX improvements
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
